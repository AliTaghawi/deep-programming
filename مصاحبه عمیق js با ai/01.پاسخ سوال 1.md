پاسخ سوال 1

# تفاوت Call Stack، Event Loop و Task Queue در جاوااسکریپت

جاوااسکریپت در محیط مرورگر و Node.js تک‌ریسمانی (single-threaded) است. برای اجرا و مدیریت هم‌زمانی کارها، سه مؤلفه اصلی دارد:

- Call Stack  
- Task Queue (صف کارهای ماکرو) و Microtask Queue (صف کارهای میکرو)  
- Event Loop  

در ادامه هر یک را جداگانه توضیح می‌دهیم و در انتها جریان اجرای آسنکرون را با هم مرور می‌کنیم.

---

## Call Stack

  
Call Stack ساختاری شبیه پشته (LIFO) است که تابع‌ها را زمان فراخوانی شدن داخل آن می‌گذارد و پس از اجرا، آنها را حذف می‌کند.  
هر بار که تابعی فراخوانی شود، فریم مربوط به آن روی Stack قرار می‌گیرد و وقتی اجرا تمام شد، Pop می‌شود.  
اگر Call Stack پر باشد یا تابعی کار سنگینی انجام دهد، رابط کاربری قفل می‌شود (UI freeze).

```javascript
function a() { console.log('داخل a'); }
function b() { a(); console.log('داخل b'); }
b();
// فراخوانی b → Stack: [b]
// داخل b فراخوانی a → Stack: [b, a]
// پس از return از a → Stack: [b]
// پس از return از b → Stack: []
```

---

## Task Queue (ماکرو تسک) و Microtask Queue (میکرو تسک)

  
ماکرو تسک‌ها (Macro-tasks) شامل callbackهایی مثل setTimeout، setInterval، رویدادهای I/O و… هستند.  
میکرو تسک‌ها (Micro-tasks) شامل callbackهای Promise (then/catch/finally)، MutationObserver و queueMicrotask می‌شوند.  
میکرو تسک‌ها همیشه اولویتی بالاتر از ماکرو دارند: پس از خالی شدن Call Stack، ابتدا همه میکرو تسک‌ها اجرا می‌شوند و سپس یک ماکرو تسک اجرا می‌شود.

---

## Event Loop

  
Event Loop به صورت مداوم وضعیت Call Stack و صف‌های تسک را بررسی می‌کند.  
وقتی Call Stack خالی است، Event Loop اولویت را به اجرای همه Microtasks می‌دهد.  
بعد از اتمام میکرو تسک‌ها، یک وظیفه از Macro-task Queue را برمی‌دارد و اجرا می‌کند.  
این چرخه تا وقتی برنامه در حال کار باشد ادامه پیدا می‌کند.

---

## جریان کلی اجرای آسنکرون

1. اجرای کد هم‌زمان (سینکرون) و پر شدن Call Stack  
2. رسیدن به عملیات آسنکرون (مثلاً setTimeout یا Promise)  
3. ثبت callback در ماکرو یا میکرو تسک کیو  
4. پایان اجرای فراخوانی اولیه و خالی شدن Call Stack  
5. Event Loop میکرو تسک‌ها را اجرا می‌کند  
6. سپس یک ماکرو تسک اجرا می‌شود  
7. تکرار مراحل 4 تا 6 تا پایان برنامه

---

## مثال عملی

```javascript
console.log('شروع');

setTimeout(() => {
  console.log('ماکرو تسک');
}, 0);

Promise.resolve()
  .then(() => console.log('میکرو تسک'))
  .then(() => console.log('دوباره میکرو'));

console.log('پایان');
```

اجرای کد به این شکل خواهد بود:  
- “شروع” (سینکرون)  
- “پایان” (سینکرون)  
- اجرای همه میکرو تسک‌ها: “میکرو تسک” → “دوباره میکرو”  
- اجرای اولین ماکرو تسک: “ماکرو تسک”

---

## نتیجه‌گیری

جاوااسکریپت با کمک Call Stack، Task Queueها و Event Loop تضمین می‌کند که کدهای هم‌زمان سریالی اجرا شوند و وظایف آسنکرون بدون قفل کردن رابط کاربری مدیریت شوند.  
تفکیک ماکرو و میکرو تسک برای اولویت‌بندی و اجرای مطلوب callbackها ضروری است.  
فهم این سه مؤلفه کلید نوشتن کدهای آسنکرون، بهینه و بدون باگ در جاوااسکریپت است.
